<!DOCTYPE html><html class="appearance-dark" lang="en"><head><meta charset="UTF-8"><title>Why MKTEMP is UNSAFE</title><meta name="description" content="Infosec Blog"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="What is MKTEMP ?Create a temporary file or directory, safely, and print its name.  TEM‚ÄêPLATE must contain at least 3 consecutive ‚ÄòX‚Äôs in last  component. If TEMPLATE is not specified, use tmp.XXXXXXXXXX, and ‚Äìtmpdir is implied. Files are created u+rw, and directories  u+rwx,  minus  umask  restric‚Äêtions. ( Taken from man page of MKTEMP )
From defination we.."><meta name="generator" content="Hexo 5.4.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">vulnfreak's blog</a></h2></section><h3 class="is-hidden-mobile is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Why MKTEMP is UNSAFE</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#What-is-MKTEMP"><span class="toc-text">What is MKTEMP ?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Why-%E2%80%93dry-run-is-unsafe-%F0%9F%98%AF"><span class="toc-text">Why ‚Äìdry-run is unsafe üòØ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Practical-Time-%F0%9F%A4%93"><span class="toc-text">Practical Time ü§ì</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#But-How-To-Modify"><span class="toc-text">But How To Modify</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/CyberSecurity"><i class="tag post-item-tag">CyberSecurity</i></a><a href="/tags/unsecure%20commands"><i class="tag post-item-tag">unsecure commands</i></a><a href="/tags/bash%20script"><i class="tag post-item-tag">bash script</i></a></header><h1 class="mt-0 mb-1" id="postTitle">Why MKTEMP is UNSAFE</h1><time class="has-text-grey" datetime="2021-02-08T09:07:00.000Z">2021-02-08</time><article class="mt-2 post-content"><h1 id="What-is-MKTEMP"><a href="#What-is-MKTEMP" class="headerlink" title="What is MKTEMP ?"></a>What is MKTEMP ?</h1><p>Create a temporary file or directory, safely, and print its name.  TEM‚ÄêPLATE must contain at least 3 consecutive ‚ÄòX‚Äôs in last  component. If TEMPLATE is not specified, use tmp.XXXXXXXXXX, and ‚Äìtmpdir is implied. Files are created u+rw, and directories  u+rwx,  minus  umask  restric‚Äêtions. ( Taken from man page of MKTEMP )</p>
<p>From defination we can saty that we have to specify the tmplate in such a way tmp.XXXX and then it will replace with the random aplabets and numbers inplace of X.</p>
<p>So it is nice to create to a temp file or directory but if we check it‚Äôs man page closely we find that if we use <strong>‚Äìdry-run OR -u</strong> it says it is unsafe.</p>
<p><img src="/assets/mktemp/man_mktemp.png" alt="man mktemp"></p>
<h1 id="Why-‚Äìdry-run-is-unsafe-üòØ"><a href="#Why-‚Äìdry-run-is-unsafe-üòØ" class="headerlink" title="Why ‚Äìdry-run is unsafe üòØ"></a>Why ‚Äìdry-run is unsafe üòØ</h1><p>We use ‚Äìdry-run so that file will not create in the system it will delte automatically just after the process end.<br>So the thing which make it unsafe is that when we initailize the command for mktemp and after that command we create file or dir so in between this if any process can create the file with the same name or in some cases we can also modify the file.</p>
<h1 id="Practical-Time-ü§ì"><a href="#Practical-Time-ü§ì" class="headerlink" title="Practical Time ü§ì"></a>Practical Time ü§ì</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dir=<span class="string">&quot;<span class="subst">$(mktemp -u)</span>&quot;</span></span><br><span class="line">mkdir <span class="string">&quot;<span class="variable">$dir</span>&quot;</span></span><br><span class="line">chmod 700 <span class="string">&quot;<span class="variable">$dir</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>In this example between mktemp and mkdir anyone can create same file with difeerent ownership.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cmd = <span class="string">&quot;/bin/vi&quot;</span></span><br><span class="line"></span><br><span class="line">tmpName=$(mktemp -u /tmp/cmd-XXXX)</span><br><span class="line"></span><br><span class="line">(<span class="built_in">umask</span> 110; touch <span class="variable">$tmpName</span>)</span><br><span class="line"></span><br><span class="line">/bin/<span class="built_in">echo</span> <span class="variable">$cmd</span> &gt;&gt;<span class="variable">$tmpName</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In this example we know that mktemp create  a temp file with name cmd-XXXX and after that it set the umask value 110 it means that root and user have read and write permission on the file.<br>In this case in between the echo process any other process of user can also modify the file data.</p>
<h1 id="But-How-To-Modify"><a href="#But-How-To-Modify" class="headerlink" title="But How To Modify"></a>But How To Modify</h1><p>It‚Äôs is simple than we think </p>
<p>We can run our another script which have following content in it </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;/bin/bash&quot;</span> | tee /tmp/cmd* &gt; /dev/null; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>Now understand what this script will do. This is simple one liner while loop bash. As it‚Äôs scondition is specified as true so it will never end and it will excute at every fast and continous and it echo <code>/bin/bash</code> in the file name cmd* ( * means any file starting with cmd ) so in this way we can modify the file data.</p>
<p>Similary in case of dir we can do this only just by replacing the echo any command we want to apply on the dir ( like chmod, sym link etc‚Ä¶) </p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2021-02-08-Laravel-CVE-2018-15133/" title="Laravel CVE-2018-15133"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: Laravel CVE-2018-15133</span></a><a class="button is-default" href="/2021-02-08-FTKImager/" title="FTK IMAGER"><span class="has-text-weight-semibold">Next: FTK IMAGER</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/vulnfreak"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/vulnfreak"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com/vulnfreak"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- Áü•‰πé--><!-- È¢ÜËã±--><a title="linkedin" target="_blank" rel="noopener nofollow" href="//www.linkedin.com/in/company/71482834/"><i class="iconfont icon-linkedin"></i></a><!-- ËÑ∏‰π¶--></section><p><span>Copyright ¬©</span><span> vulnfreak 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>